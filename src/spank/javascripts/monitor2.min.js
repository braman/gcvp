function _init(e){location.href="#!monitor";jQuery("head").append(jQuery("<link rel='stylesheet' href='stylesheets/app.min.css' />"));document.title="CQ - Monitor";if(e.lang){_lang=e.lang;var t="";console.log("Lang: "+_lang);if(_lang=="kk"){kk_ru=_kk}else if(_lang=="ru"){kk_ru=_ru}jQuery("#help").append(kk_ru.help);jQuery(".settings").append(kk_ru.settings);jQuery("#logoutLink").append(kk_ru.quit);jQuery("#go_to_statistics").append(kk_ru.go_to_statistics);jQuery("#go_to_tickets").text(kk_ru.go_to_tickets);jQuery(".line").append(kk_ru.line);jQuery(".all").append(kk_ru.all);jQuery(".reserve").append(kk_ru.reserve);jQuery("#serviced").append(kk_ru.serviced);jQuery("#not_came").append(kk_ru.notcame);jQuery("#routed").append(kk_ru.routed);jQuery(".operator").append(kk_ru.operator);jQuery("#window").append(kk_ru.window);jQuery("#call_time").append(kk_ru.call_time);jQuery("#start_time").append(kk_ru.start_time);jQuery("#ticket_number").text(kk_ru.ticket_number);jQuery("#excell").append(kk_ru.excellent);jQuery("#good").append(kk_ru.good);jQuery("#bad").append(kk_ru.bad);jQuery("#average").append(kk_ru.average);jQuery(".history").append(kk_ru.hi);jQuery(".ticket").append(kk_ru.ticket);jQuery(".start").append(kk_ru.start);jQuery(".end").append(kk_ru.end);jQuery("#monitoring").text(kk_ru.monitoring);jQuery(".mark").append(kk_ru.mark)}jQuery(".error").hide();onConnect()}function _initFromStatistics(e){console.log(e);location.href="#!monitor";document.title="CQ - Monitor";jQuery(".error").hide();_lang=e;var t="";console.log("Lang: "+_lang);if(_lang=="kk"){kk_ru=_kk}else if(_lang=="ru"){kk_ru=_ru}else if(_lang=="en"){kk_ru=_ru}jQuery("#help").append(kk_ru.help);jQuery(".settings").append(kk_ru.settings);jQuery("#logoutLink").append(kk_ru.quit);jQuery("#go_to_statistics").append(kk_ru.go_to_statistics);jQuery("#go_to_tickets").text(kk_ru.go_to_tickets);jQuery(".line").append(kk_ru.line);jQuery(".all").append(kk_ru.all);jQuery(".reserve").append(kk_ru.reserve);jQuery("#serviced").append(kk_ru.serviced);jQuery("#not_came").append(kk_ru.notcame);jQuery("#monitoring").text(kk_ru.monitoring);jQuery("#routed").append(kk_ru.routed);jQuery(".operator").append(kk_ru.operator);jQuery("#window").append(kk_ru.window);jQuery("#call_time").append(kk_ru.call_time);jQuery("#start_time").append(kk_ru.start_time);jQuery("#ticket_time").append(kk_ru.ticket_number);jQuery("#excell").append(kk_ru.excellent);jQuery("#good").append(kk_ru.good);jQuery("#bad").append(kk_ru.bad);jQuery("#average").append(kk_ru.average);jQuery(".history").append(kk_ru.hi);jQuery(".ticket").append(kk_ru.ticket);jQuery(".start").append(kk_ru.start);jQuery(".end").append(kk_ru.end);jQuery(".mark").append(kk_ru.mark);onConnect()}function onConnect(){XmppClient.send("queue","init")}function _onMessage(e){console.log("_onMessage:"+e);var t={};try{t=JSON.parse(e)}catch(n){console.warn("unit got non-JSON message:"+e);return}if(t.username){jQuery("#username").text(t.username)}if(t.laneStats){_laneStats=t.laneStats;updateLaneStats()}if(t.unitStats){_unitStats=t.unitStats;jQuery("#unit-stats tbody").empty();jQuery(_unitStats).each(function(e){var t=_unitStats[e];jQuery("#unit-stats tbody").append("<tr data-unit='"+t.username+"'>"+"<td><a href='#' onclick='showUnit(\""+t.username+"\")'>"+t.firstname+" "+t.lastname+"</a></td>"+"<td>"+t.window+"</td>"+"<td data-type='lane'>"+(_lanes[t.lane]!=undefined?_lanes[t.lane]:"")+"</td>"+"<td data-type='called'>"+(t.called!=undefined?t.called:"")+"</td>"+"<td data-type='started'>"+(t.started!=undefined?t.started:"")+"</td>"+"<td data-type='ticket'>"+(t.ticketCode!=undefined?t.ticketCode:"")+"</td>"+"<td data-stat='tokenAll'>"+t.tokenAll+"</td>"+"<td data-stat='countReserved'>"+t.countReserved+"</td>"+"<td data-stat='countMarkGood'>"+t.countMarkGood+"</td>"+"<td data-stat='countMarkNorm'>"+t.countMarkNorm+"</td>"+"<td data-stat='countMarkBad'>"+t.countMarkBad+"</td>"+"<td data-stat='markAverage'>"+t.markAverage+"</td>"+"</tr>")})}if(_laneStats.length==undefined||_unitStats.length==undefined){_msgBuffer.push(t);return}else{if(_msgBuffer.length!=0){jQuery(_msgBuffer).each(function(e){processMessage(_msgBuffer[e])});_msgBuffer=new Array}}processMessage(t)}function processMessage(msg){if(msg.called){var unit=jQuery("tr[data-unit='"+msg.unit+"']");unit.find("td[data-type=ticket]").text(msg.ticket);unit.find("td[data-type=lane]").text(_lanes[msg.lane]);unit.find("td[data-type=called]").text(msg.called);jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane){t.called+=1}});updateLaneStats();jQuery(_unitStats).each(function(e){var t=_unitStats[e];if(t.username==msg.unit){t.called=msg.called}})}else if(msg.started){var unit=jQuery("tr[data-unit='"+msg.unit+"']");unit.find("td[data-type=ticket]").text(msg.ticket);unit.find("td[data-type=lane]").text(_lanes[msg.lane]);unit.find("td[data-type=started]").text(msg.started);jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane){t.started+=1}});updateLaneStats();jQuery(_unitStats).each(function(e){var t=_unitStats[e];if(t.username==msg.unit){t.started=msg.started}})}else if(msg.ended){var unit=jQuery("tr[data-unit='"+msg.unit+"']");unit.find("td[data-type]").text("");console.log("msg.ended");var startedTime;var calledTime;var unitRealName;jQuery(_unitStats).each(function(ix){var el=_unitStats[ix];if(el.username==msg.unit){startedTime=el.started;calledTime=el.called;unitRealName=el.firstname+" "+el.lastname;el.ended.push({ticket:msg.ticket,tokenId:msg.tokenId,isTicketReserved:msg.isTicketReserved,lane:msg.lane,call:el.called,start:el.started,end:msg.ended,mark:2});el.called=undefined;el.started=undefined;jQuery(el.ended).each(function(e){var t=el.ended[e];console.log("jel.tokenId == msg.tokenId : "+t.tokenId+" == "+msg.tokenId);if(t.tokenId==msg.tokenId&&t.tokenId!=undefined)t.isTicketReserved=msg.isTicketReserved});unit.find("td[data-stat='tokenAll']").text(msg.tokenAll);if(msg.isTicketReserved){var countReserved=eval(unit.find("td[data-stat='countReserved']").text());unit.find("td[data-stat='countReserved']").text(++countReserved)}unit.find("td[data-stat='countMarkGood']").text(msg.countMarkGood);unit.find("td[data-stat='countMarkNorm']").text(msg.countMarkNorm);unit.find("td[data-stat='countMarkBad']").text(msg.countMarkBad);unit.find("td[data-stat='markAverage']").text(msg.markAverage)}});jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane&&t.lane!=undefined){console.log("showLane laneFound");console.log(t.history);t.history.push({ticket:msg.ticket,tokenId:msg.tokenId,call:calledTime,start:startedTime,end:msg.ended,mark:2,isTicketReserved:msg.isTicketReserved,unitRealName:unitRealName});t.ended+=1;if(msg.isTicketReserved)t.countReserved+=1}});updateLaneStats()}else if(msg.missed){var unit=jQuery("tr[data-unit='"+msg.unit+"']");unit.find("td[data-type]").text("");jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane){t.missed+=1}});updateLaneStats();jQuery(_unitStats).each(function(e){var t=_unitStats[e];if(t.username==msg.unit){t.missed.push({ticket:msg.ticket,lane:msg.lane,call:t.called,start:t.started,end:msg.missed});t.called=undefined;t.started=undefined}})}else if(msg.transferred){var unit=jQuery("tr[data-unit='"+msg.unit+"']");unit.find("td[data-type]").text("");jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane){t.transferred+=1}if(t.lane==msg.nextLane){t.created+=1}});updateLaneStats();jQuery(_unitStats).each(function(e){var t=_unitStats[e];if(t.username==msg.unit){t.transferred.push({ticket:msg.ticket,lane:msg.lane,targetLane:msg.nextLane,call:t.called,start:t.started,end:msg.transferred});t.called=undefined;t.started=undefined}})}else if(msg.newticket){jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.newticket.lane){t.created+=1}});updateLaneStats()}else if(msg.smile){console.log("Yahoo! MARK");var unit=jQuery("tr[data-unit='"+msg.unit+"']");jQuery(_unitStats).each(function(e){var t=_unitStats[e];if(t.username==msg.unit){console.log("msg.unit is found");unit.find("td[data-stat='tokenAll']").text(msg.tokenAll);console.log(msg.countMarkGood);unit.find("td[data-stat='countMarkGood']").text(msg.countMarkGood);unit.find("td[data-stat='countMarkNorm']").text(msg.countMarkNorm);unit.find("td[data-stat='countMarkBad']").text(msg.countMarkBad);unit.find("td[data-stat='markAverage']").text(msg.markAverage);jQuery(t.ended).each(function(e){var n=t.ended[e];console.log("jel.tokenId == msg.tokenId : "+n.tokenId+" == "+msg.tokenId);if(n.tokenId==msg.tokenId&&n.tokenId!=undefined)n.mark=msg.mark});t.tokenAll=msg.tokenAll;t.countMarkGood=msg.countMarkGood;t.countMarkNorm=msg.countMarkNorm;t.countMarkBad=msg.countMarkBad;t.markAverage=msg.markAverage}});jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane&&t.lane!=undefined){jQuery(t.history).each(function(e){var n=t.history[e];console.log("jel.tokenId == msg.tokenId : "+n.tokenId+" == "+msg.tokenId);if(n.tokenId==msg.tokenId&&n.tokenId!=undefined)n.mark=msg.mark})}})}console.log(msg)}function getUnit(e){var t={};jQuery(_unitStats).each(function(n){if(_unitStats[n].username==e){t=_unitStats[n]}});return t}function updateLaneStats(){jQuery("#lane-stats tbody tr").remove();jQuery(_laneStats).each(function(e){var t=_laneStats[e];_lanes[t.lane]=t.laneText;jQuery("#lane-stats tbody").append("<tr data-lane='"+t.lane+"'><td><a href='javascript:showLane(\""+t.lane+"\")' >"+t.laneText+"</a></td><td>"+t.created+"</td><td>"+t.countReserved+"</td><td>"+t.ended+"</td><td>"+t.missed+"</td><td>"+t.transferred+"</td></tr>")})}function showLane(e){jQuery(_laneStats).each(function(t){var n=_laneStats[t];if(e==n.lane&&n.lane!=undefined){jQuery("#laneModal legend div span#laneName").text(kk_ru.line+": "+n.laneText);jQuery("#laneModal tbody").empty();console.log("showLane laneFound");console.log(n.history);for(var r in n.history){var i=n.history[r];console.log(i);jQuery("#laneModal tbody").append("<tr>");jQuery("#laneModal tbody").append("<td>"+i.unitRealName+"</td>");var s=i.isTicketReserved?" "+kk_ru.reserve:"";jQuery("#laneModal tbody").append("<td>"+i.ticket+s+"</td>");jQuery("#laneModal tbody").append("<td>"+i.start+"</td><td>"+i.end+"</td>");var o="";switch(i.mark){case 0:o="";break;case 5:o=kk_ru.excellent;break;case 3:o=kk_ru.good;break;case 1:o=kk_ru.bad;break}jQuery("#laneModal tbody").append("<td>"+o+"</td>");jQuery("#laneModal tbody").append("</tr>")}$("#laneModal").foundation("reveal","open")}});return false}function showUnit(e){jQuery(_unitStats).each(function(t){var n=_unitStats[t];if(e.indexOf(n.username)!=-1){jQuery("#unitModal legend div span#unitRealname").text("Оператор: "+n.firstname+" "+n.lastname);jQuery("#unitModal legend div span#unitUsername").text("Логин: "+n.username);jQuery("#unitModal ul.unitLanes").empty();jQuery(n.lanes).each(function(e){jQuery("#unitModal ul.unitLanes").append("<li><span class='label'>"+n.lanes[e].laneText+"</span></li>")});jQuery("#unitModal tbody").empty();jQuery(n.ended).each(function(e){var t=n.ended[e];var r=t.laneText;if(r==undefined){for(var i in _lanes)if(i==t.lane){r=_lanes[i];break}}jQuery("#unitModal tbody").append("<tr>");jQuery("#unitModal tbody").append("<td>"+r+"</td>");var s=t.isTicketReserved?" Бронь":"";console.log("jel.isTicketReserved = "+t.isTicketReserved+" isReservedText = "+s);jQuery("#unitModal tbody").append("<td>"+t.ticket+s+"</td>");jQuery("#unitModal tbody").append("<td>"+t.start+"</td><td>"+t.end+"</td>");var o="";switch(t.mark){case 0:o="";break;case 5:o=kk_ru.excellent;break;case 3:o=kk_ru.good;break;case 1:o=kk_ru.bad;break}jQuery("#unitModal tbody").append("<td>"+o+"</td>");jQuery("#unitModal tbody").append("</tr>")});$("#unitModal").foundation("reveal","open")}});return false}function goToStatictics(){console.log("gotostatistics");jQuery("#body").load("/statistics.html",function(e){if(typeof _init=="function"){_init()}jQuery("#body").show()})}function goToTickets(){console.log("gototickets");jQuery("#body").load("/tickets.html",function(e){if(typeof _init=="function"){_init()}jQuery("#body").show()})}function _onStatus(e){if(e=="CONNECTED"||e=="ATTACHED"){onConnect()}if(e=="DISCONNECTED"){console.log("Disconnected")}}function getSettings(){jQuery("#messageBody").html("<p>"+kk_ru.choose_lang+"</p>"+'<label for="ru_lang"><input type="radio" id="ru_lang" name="lang" value="ru" />Русский</label>'+'<label for="kk_lang"><input type="radio" id="kk_lang" name="lang" value="kk" />Казахский</label>');$("#message").foundation("reveal","open")}function change_lang(){var e=document.getElementsByName("lang");for(var t=0;t<e.length;t++){if(e[t].checked){_lang=e[t].value}}if(_lang=="kk"){kk_ru=_kk}else if(_lang=="ru"){kk_ru=_ru}else if(_lang=="en"){kk_ru=_ru}jQuery("#help").empty();jQuery("#help").append(kk_ru.help);jQuery(".settings").empty();jQuery(".settings").append(kk_ru.settings);jQuery("#logoutLink").empty();jQuery("#logoutLink").append(kk_ru.quit);jQuery("#go_to_statistics").empty();jQuery("#go_to_statistics").append(kk_ru.go_to_statistics);jQuery("#go_to_tickets").text(kk_ru.go_to_tickekk_ru.go_to_statisticsts);jQuery(".line").empty();jQuery(".line").append(kk_ru.line);jQuery(".all").empty();jQuery(".all").append(kk_ru.all);jQuery(".reserve").empty();jQuery(".reserve").append(kk_ru.reserve);jQuery("#serviced").empty();jQuery("#serviced").append(kk_ru.serviced);jQuery("#not_came").empty();jQuery("#not_came").append(kk_ru.notcame);jQuery("#routed").empty();jQuery("#routed").append(kk_ru.routed);jQuery(".operator").empty();jQuery(".operator").append(kk_ru.operator);jQuery("#window").empty();jQuery("#window").append(kk_ru.window);jQuery("#call_time").empty();jQuery("#call_time").append(kk_ru.call_time);jQuery("#start_time").empty();jQuery("#start_time").append(kk_ru.start_time);jQuery("#ticket_time").empty();jQuery("#ticket_time").append(kk_ru.ticket_number);jQuery("#excell").empty();jQuery("#excell").append(kk_ru.excellent);jQuery("#good").empty();jQuery("#good").append(kk_ru.good);jQuery("#bad").empty();jQuery("#bad").append(kk_ru.bad);jQuery("#average").empty();jQuery("#average").append(kk_ru.average);jQuery(".history").empty();jQuery(".history").append(kk_ru.hi);jQuery(".ticket").empty();jQuery(".ticket").append(kk_ru.ticket);jQuery(".start").empty();jQuery(".start").append(kk_ru.start);jQuery(".end").empty();jQuery(".end").append(kk_ru.end);jQuery(".mark").empty();jQuery(".mark").append(kk_ru.mark);jQuery("#monitoring").text(kk_ru.monitoring);console.log("LANGUAGE IS: "+_lang);$("#message").foundation("reveal","close");XmppClient.send("queue",JSON.stringify({action:"changeLang",user:sessionStorage.jid,language:_lang}))}function saveText(){var e=kk_ru.line+";"+kk_ru.all+";"+kk_ru.reserve+";"+kk_ru.serviced+";"+kk_ru.notcame+";"+kk_ru.routed+"\n";jQuery(_laneStats).each(function(t){var n=_laneStats[t];e+=n.laneText+";"+n.created+";"+n.countReserved+";"+n.ended+";"+n.missed+";"+n.transferred+"\n"});var t=new Blob([e],{type:"text/plain;charset=Unicode"});saveAs(t,"monitor_lane.csv");return false}function saveUnitText(){var e=kk_ru.operator+";"+kk_ru.window+";"+kk_ru.line+";"+kk_ru.call_time+";"+kk_ru.start_time+";"+kk_ru.ticket_number+";"+kk_ru.all+";"+kk_ru.reserve+";"+kk_ru.excellent+";"+kk_ru.good+";"+kk_ru.bad+";"+kk_ru.average+"\n";jQuery(_unitStats).each(function(t){var n=_unitStats[t];e+=n.firstname+" "+n.lastname+";"+n.window+";"+(_lanes[n.lane]!=undefined?_lanes[n.lane]:"")+";"+(n.called!=undefined?n.called:"")+";"+(n.started!=undefined?n.started:"")+";"+(n.ticketCode!=undefined?n.ticketCode:"")+";"+n.tokenAll+";"+n.countReserved+";"+n.countMarkGood+";"+n.countMarkNorm+";"+ +n.countMarkBad+";"+n.markAverage+"\n"});var t=new Blob([e],{type:"text/plain;charset=Unicode"});saveAs(t,"monitor_unit.csv");return false}var _kk={help:"Көмек",settings:"Қондырғылар",quit:"Шығу",monitoring:"Бақылау",go_to_statistics:"Санаққа өту",go_to_tickets:"Текущие билеты",line:"Қызмет тізімі",all:"Барлығы",reserve:"Бронь",serviced:"Қызмет корсетілген",notcame:"Келмеген клиенттер",routed:"Қайта бағытталған",operator:"Оператор",window:"Терезе",call_time:"Шақырылған уақыты",start_time:"Басталған уақыты",ticket_number:"Билет нөмірі",excellent:"Өте жақсы",good:"Орташа",bad:"Нашар",average:"Орташа бағасы",history:"Тарихы",ticket:"Билет",start:"Басы",end:"Соңы",mark:"Бағасы",choose_lang:"Тіл таңдаңыз"};var _ru={help:"Помощь",settings:"Настройки",quit:"Выход",monitoring:"Мониторинг",go_to_statistics:"Перейти на статистику",go_to_tickets:"Текущие билеты",line:"Услуги",all:"Всего",reserve:"Бронь",serviced:"Обслужено",notcame:"Клиент не пришел",routed:"Перенаправленные",operator:"Оператор",window:"Окно",call_time:"Время вызова",start_time:"Время начала",ticket_number:"Номер билета",excellent:"Отлично",good:"Удовлетворительно",bad:"Плохо",average:"Средняя оценка",history:"История",ticket:"Билет",start:"Начало",end:"Конец",mark:"Оценка",choose_lang:"Выберите язык"};var _unitStats={};var _laneStats={};var _lanes={};var _msgBuffer=new Array;var _lang=null;var kk_ru=_ru;jQuery("#logoutLink").click(function(){console.log("logoutLink was clicked");window.location="/";sessionStorage.clear();XmppClient.connection.disconnect()})