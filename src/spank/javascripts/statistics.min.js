function _init(){location.href="#!statistics";document.title="CQ - Statistics";jQuery(".error").hide();onConnect()}function onConnect(){var e={action:"toStatictics"};XmppClient.send("queue",JSON.stringify(e))}function _onMessage(e){console.log("_onMessage:"+e);var t={};try{t=JSON.parse(e)}catch(n){console.warn("unit got non-JSON message:"+e);return}_msg=t;_lang=t.lang;if(_lang){if(_lang=="ru"){kk_ru=_ru}else if(_lang=="kk"){kk_ru=_kk}else if(_lang=="en"){kk_ru=_en}jQuery(".settings").empty();jQuery("#help").empty();jQuery("#logoutLink").empty();jQuery("#statistics_title").empty();jQuery("#monitoring_title").empty();jQuery(".line_title").empty();jQuery(".all").empty();jQuery(".reserve").empty();jQuery("#serviced").empty();jQuery("#not_came").empty();jQuery("#postponed").empty();jQuery(".operator_title").empty();jQuery("#window").empty();jQuery("#call_time").empty();jQuery("#start_time").empty();jQuery("#ticket_number").empty();jQuery("#excell").empty();jQuery("#good").empty();jQuery("#bad").empty();jQuery("#average_mark").empty();jQuery(".settings").append(kk_ru.settings);jQuery("#help").append(kk_ru.help);jQuery("#logoutLink").append(kk_ru.quit);jQuery("#statistics_title").append(kk_ru.statistics);jQuery("#monitoring_title").append(kk_ru.monitoring);jQuery(".line_title").append(kk_ru.line);jQuery(".all").append(kk_ru.all);jQuery(".reserve").append(kk_ru.reserve);jQuery("#serviced").append(kk_ru.serviced);jQuery("#not_came").append(kk_ru.not_came);jQuery("#postponed").append(kk_ru.postponed);jQuery(".operator_title").append(kk_ru.operator);jQuery("#window").append(kk_ru.window);jQuery("#call_time").append(kk_ru.call_time);jQuery("#start_time").append(kk_ru.start_time);jQuery("#ticket_number").append(kk_ru.ticket_number);jQuery("#excell").append(kk_ru.excellent);jQuery("#good").append(kk_ru.good);jQuery("#bad").append(kk_ru.bad);jQuery("#average_mark").append(kk_ru.average)}if(t.dateRepresent){jQuery("#representDate").text(t.dateRepresent)}if(t.username){jQuery("#username").text(t.username)}if(t.laneStats){_laneStats=t.laneStats;updateLaneStats()}if(t.unitStats){_unitStats=t.unitStats;jQuery("#unit-stats tbody").empty();jQuery(_unitStats).each(function(e){var t=_unitStats[e];jQuery("#unit-stats tbody").append("<tr data-unit='"+t.username+"'>"+"<td><a href='#' onclick='showUnit(\""+t.username+"\")'>"+t.firstname+" "+t.lastname+"</a></td>"+"<td>"+t.window+"</td>"+"<td data-stat='tokenAll'>"+t.tokenAll+"</td>"+"<td data-stat='countReserved'>"+t.countReserved+"</td>"+"<td data-stat='countMarkGood'>"+t.countMarkGood+"</td>"+"<td data-stat='countMarkNorm'>"+t.countMarkNorm+"</td>"+"<td data-stat='countMarkBad'>"+t.countMarkBad+"</td>"+"<td data-stat='markAverage'>"+t.markAverage+"</td>"+"</tr>")})}if(_laneStats.length==undefined||_unitStats.length==undefined){_msgBuffer.push(t);return}else{if(_msgBuffer.length!=0){jQuery(_msgBuffer).each(function(e){processMessage(_msgBuffer[e])});_msgBuffer=new Array}}}function processMessage(msg){if(msg.called){var unit=jQuery("tr[data-unit='"+msg.unit+"']");unit.find("td[data-type=ticket]").text(msg.ticket);unit.find("td[data-type=lane]").text(_lanes[msg.lane]);unit.find("td[data-type=called]").text(msg.called);jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane){t.called+=1}});updateLaneStats();jQuery(_unitStats).each(function(e){var t=_unitStats[e];if(t.username==msg.unit){t.called=msg.called}})}else if(msg.started){var unit=jQuery("tr[data-unit='"+msg.unit+"']");unit.find("td[data-type=ticket]").text(msg.ticket);unit.find("td[data-type=lane]").text(_lanes[msg.lane]);unit.find("td[data-type=started]").text(msg.started);jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane){t.started+=1}});updateLaneStats();jQuery(_unitStats).each(function(e){var t=_unitStats[e];if(t.username==msg.unit){t.started=msg.started}})}else if(msg.ended){var unit=jQuery("tr[data-unit='"+msg.unit+"']");unit.find("td[data-type]").text("");console.log("msg.ended");var startedTime;var calledTime;var unitRealName;jQuery(_unitStats).each(function(ix){var el=_unitStats[ix];if(el.username==msg.unit){startedTime=el.started;calledTime=el.called;unitRealName=el.firstname+" "+el.lastname;el.ended.push({ticket:msg.ticket,tokenId:msg.tokenId,isTicketReserved:msg.isTicketReserved,lane:msg.lane,call:el.called,start:el.started,end:msg.ended,mark:2});el.called=undefined;el.started=undefined;jQuery(el.ended).each(function(e){var t=el.ended[e];console.log("jel.tokenId == msg.tokenId : "+t.tokenId+" == "+msg.tokenId);if(t.tokenId==msg.tokenId&&t.tokenId!=undefined)t.isTicketReserved=msg.isTicketReserved});unit.find("td[data-stat='tokenAll']").text(msg.tokenAll);if(msg.isTicketReserved){var countReserved=eval(unit.find("td[data-stat='countReserved']").text());unit.find("td[data-stat='countReserved']").text(++countReserved)}unit.find("td[data-stat='countMarkGood']").text(msg.countMarkGood);unit.find("td[data-stat='countMarkNorm']").text(msg.countMarkNorm);unit.find("td[data-stat='countMarkBad']").text(msg.countMarkBad);unit.find("td[data-stat='markAverage']").text(msg.markAverage)}});jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane&&t.lane!=undefined){console.log("showLane laneFound");console.log(t.history);t.history.push({ticket:msg.ticket,tokenId:msg.tokenId,call:calledTime,start:startedTime,end:msg.ended,mark:2,isTicketReserved:msg.isTicketReserved,unitRealName:unitRealName});t.ended+=1;if(msg.isTicketReserved)t.countReserved+=1}});updateLaneStats()}else if(msg.missed){var unit=jQuery("tr[data-unit='"+msg.unit+"']");unit.find("td[data-type]").text("");jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane){t.missed+=1}});updateLaneStats();jQuery(_unitStats).each(function(e){var t=_unitStats[e];if(t.username==msg.unit){t.missed.push({ticket:msg.ticket,lane:msg.lane,call:t.called,start:t.started,end:msg.missed});t.called=undefined;t.started=undefined}})}else if(msg.transferred){var unit=jQuery("tr[data-unit='"+msg.unit+"']");unit.find("td[data-type]").text("");jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane){t.transferred+=1}if(t.lane==msg.nextLane){t.created+=1}});updateLaneStats();jQuery(_unitStats).each(function(e){var t=_unitStats[e];if(t.username==msg.unit){t.transferred.push({ticket:msg.ticket,lane:msg.lane,targetLane:msg.nextLane,call:t.called,start:t.started,end:msg.transferred});t.called=undefined;t.started=undefined}})}else if(msg.newticket){jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.newticket.lane){t.created+=1}});updateLaneStats()}else if(msg.smile){console.log("Yahoo! MARK");var unit=jQuery("tr[data-unit='"+msg.unit+"']");jQuery(_unitStats).each(function(e){var t=_unitStats[e];if(t.username==msg.unit){console.log("msg.unit is found");unit.find("td[data-stat='tokenAll']").text(msg.tokenAll);unit.find("td[data-stat='countMarkGood']").text(msg.countMarkGood);unit.find("td[data-stat='countMarkNorm']").text(msg.countMarkNorm);unit.find("td[data-stat='countMarkBad']").text(msg.countMarkBad);unit.find("td[data-stat='markAverage']").text(msg.markAverage);jQuery(t.ended).each(function(e){var n=t.ended[e];console.log("jel.tokenId == msg.tokenId : "+n.tokenId+" == "+msg.tokenId);if(n.tokenId==msg.tokenId&&n.tokenId!=undefined)n.mark=msg.mark});t.tokenAll=msg.tokenAll;t.countMarkGood=msg.countMarkGood;t.countMarkNorm=msg.countMarkNorm;t.countMarkBad=msg.countMarkBad;t.markAverage=msg.markAverage}});jQuery(_laneStats).each(function(e){var t=_laneStats[e];if(t.lane==msg.lane&&t.lane!=undefined){jQuery(t.history).each(function(e){var n=t.history[e];console.log("jel.tokenId == msg.tokenId : "+n.tokenId+" == "+msg.tokenId);if(n.tokenId==msg.tokenId&&n.tokenId!=undefined)n.mark=msg.mark})}})}console.log(msg)}function getUnit(e){var t={};jQuery(_unitStats).each(function(n){if(_unitStats[n].username==e){t=_unitStats[n]}});return t}function updateLaneStats(){jQuery("#lane-stats tbody").empty();jQuery(_laneStats).each(function(e){var t=_laneStats[e];_lanes[t.lane]=t.laneText;jQuery("#lane-stats tbody").append("<tr data-lane='"+t.lane+"'><td><a href='javascript:showLane(\""+t.lane+"\")' >"+t.laneText+"</a></td><td>"+t.created+"</td><td>"+t.countReserved+"</td><td>"+t.ended+"</td><td>"+t.missed+"</td><td>"+t.transferred+"</td></tr>")})}function showLane(e){jQuery(_laneStats).each(function(t){var n=_laneStats[t];if(e==n.lane&&n.lane!=undefined){jQuery("#laneModal legend div span#laneName").text(kk_ru.line+": "+n.laneText);jQuery("#laneModal tbody").empty();console.log("showLane laneFound");console.log(n.history);for(var r in n.history){var i=n.history[r];console.log(i);jQuery("#laneModal tbody").append("<tr>");jQuery("#laneModal tbody").append("<td>"+i.unitRealName+"</td>");var s=i.isTicketReserved?" "+kk_ru.reserve:"";jQuery("#laneModal tbody").append("<td>"+i.ticket+s+"</td>");if(i.start)jQuery("#laneModal tbody").append("<td>"+i.start+"</td><td>"+i.end+"</td>");var o="";switch(i.mark){case 0:o="";break;case 5:o=kk_ru.excellent;break;case 3:o=kk_ru.good;break;case 1:o=kk_ru.bad;break}jQuery("#laneModal tbody").append("<td>"+o+"</td>");jQuery("#laneModal tbody").append("</tr>")}$("#laneModal").foundation("reveal","open")}});return false}function showUnit(e){jQuery(_unitStats).each(function(t){var n=_unitStats[t];if(e.indexOf(n.username)!=-1){jQuery("#unitModal legend div span#unitRealname").text(kk_ru.operator+": "+n.firstname+" "+n.lastname);jQuery("#unitModal legend div span#unitUsername").text("Логин: "+n.username);jQuery("#unitModal ul.unitLanes").empty();jQuery(n.lanes).each(function(e){jQuery("#unitModal ul.unitLanes").append("<li><span class='label'>"+n.lanes[e].laneText+"</span></li>")});$tbody=jQuery("#unitModal tbody");$tbody.empty();jQuery(n.ended).each(function(e){var t=n.ended[e];var r=t.laneText;if(r==undefined){for(var i in _lanes)if(i==t.lane){r=_lanes[i];break}}if(t.start){$tbody.append("<tr>");$tbody.append("<td>"+r+"</td>");var s=t.isTicketReserved?" "+kk_ru.reserve:"";console.log("jel.isTicketReserved = "+t.isTicketReserved+" isReservedText = "+s);$tbody.append("<td>"+t.ticket+s+"</td>");$tbody.append("<td>"+t.start+"</td><td>"+t.end+"</td>");var o="";switch(t.mark){case 0:o="";break;case 5:o=kk_ru.excellent;break;case 3:o=kk_ru.good;break;case 1:o=kk_ru.bad;break}$tbody.append("<td>"+o+"</td></tr>")}});$("#unitModal").foundation("reveal","open")}});return false}function showRepresentDate(){var e=new Date;var t=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0,0);var n=$("#datepickerFrom").fdatepicker({format:"dd.mm.yyyy"}).on("changeDate",function(e){if(e.date.valueOf()>r.date.valueOf()){var t=new Date(e.date);t.setDate(t.getDate()+1);r.setValue(t)}n.hide();$("#datepickerTo")[0].focus()}).data("datepicker");var r=$("#datepickerTo").fdatepicker({format:"dd.mm.yyyy",onRender:function(e){return e.valueOf()<=n.date.valueOf()?"disabled":""}}).on("changeDate",function(e){r.hide()}).data("datepicker");if(firstTime==0){$("body").append(jQuery("<script src='javascripts/foundation/foundation.datepicker.js'></script"))}$("#representDateModal").foundation("reveal","open")}function goToDate(){var e=jQuery("#datepickerFrom").val();var t=jQuery("#datepickerTo").val();console.log(e);if(!isDate(e,".")){jQuery("label#datepickerFrom_error").html("Некорректная дата.");jQuery("label#datepickerFrom_error").show();jQuery("input#datepickerFrom").focus();return}if(!isDate(t,".")){jQuery("label#datepickerTo_error").html("Некорректная дата.");jQuery("label#datepickerTo_error").show();jQuery("input#datepickerTo").focus();return}jQuery(".error").hide();$("#representDateModal").foundation("reveal","close");var n={action:"monitor_representDate",dateFrom:e,dateTo:t};XmppClient.send("queue",JSON.stringify(n))}function goToMonitoring(){console.log("gotomonitoring");var e=_lang;jQuery("#body").load("/monitor2.html",function(t){_initFromStatistics(e);jQuery("#body").show()})}function getSettings(){jQuery("#messageBody").html("<p>"+kk_ru.choose_lang+"</p>"+'<label for="ru_lang"><input type="radio" id="ru_lang" name="lang" value="ru" />Русский</label>'+'<label for="kk_lang"><input type="radio" id="kk_lang" name="lang" value="kk" />Казахский</label>'+'<label for="en_lang"><input type="radio" id="en_lang" name="lang" value="en" />English</label>');$("#message").foundation("reveal","open")}function change_lang(){var e=document.getElementsByName("lang");for(var t=0;t<e.length;t++){if(e[t].checked){_lang=e[t].value}}if(_lang=="kk"){kk_ru=_kk}else if(_lang=="ru"){kk_ru=_ru}else if(_lang=="en"){kk_ru=_en}console.log("LANGUAGE IS: "+_lang);$("#message").foundation("reveal","close");XmppClient.send("queue",JSON.stringify({action:"changeLang",user:sessionStorage.jid,language:_lang}))}function _onStatus(e){if(e=="CONNECTED"||e=="ATTACHED"){onConnect()}if(e=="DISCONNECTED"){console.log("Disconnected")}}function isDate(e,t,n,r,i){try{e=e.replace(/-/g,"/").replace(/\./g,"/");t=t===undefined?"/":t.replace(/-/g,"/").replace(/\./g,"/");var s=e.split(t);if(s.length!=3){return false}if(n===undefined||r===undefined||i===undefined){if(s[0]>31){i=0;r=1;n=2}else{i=2;r=1;n=0}}var o=n!==undefined?n:0;var u=r!==undefined?r:1;var a=i!==undefined?i:2;console.log(s);console.log(o);console.log(u);console.log(a);var f=true;if(!(s[o].length==1||s[o].length==2)){f=false}console.log(f);if(f&&!(s[u].length==1||s[u].length==2)){f=false}console.log(f);if(f&&s[a].length!=4){f=false}console.log(f);if(f){var l=parseInt(s[o],10);var c=parseInt(s[u],10);var h=parseInt(s[a],10);var p=[31,28,31,30,31,30,31,31,30,31,30,31];if(f=c<=12&&c>0){var d=(h&3)==0&&(h%25!=0||(h&15)==0);p[1]=d?29:28;f=l>0&&l<=p[c-1]}}console.log(f);return f}catch(v){return false}}function saveLaneStat(){var e=jQuery("#representDate").text()+"\n"+kk_ru.line+";"+kk_ru.all+";"+kk_ru.reserve+";"+kk_ru.serviced+";"+kk_ru.not_came+";"+kk_ru.postponed+"\n";jQuery(_laneStats).each(function(t){var n=_laneStats[t];e+=n.laneText+";"+n.created+";"+n.countReserved+";"+n.ended+";"+n.missed+";"+n.transferred+"\n"});var t=new Blob([e],{type:"text/plain;charset=Unicode"});saveAs(t,"statistics_lane.csv");return false}function saveUnitStat(){var e=jQuery("#representDate").text()+"\n"+kk_ru.operator+";"+kk_ru.window+";"+kk_ru.all+";"+kk_ru.reserve+";"+kk_ru.excellent+";"+kk_ru.good+";"+kk_ru.bad+";"+kk_ru.average+"\n";jQuery(_unitStats).each(function(t){var n=_unitStats[t];e+=n.firstname+" "+n.lastname+";"+n.window+";"+n.tokenAll+";"+n.countReserved+";"+n.countMarkGood+";"+n.countMarkNorm+";"+n.countMarkBad+";"+n.markAverage+"\n"});var t=new Blob([e],{type:"text/plain;charset=Unicode"});saveAs(t,"statistics_unit.csv");return false}var _msg=null;var _lang=null;var _kk={help:"Көмек",settings:"Қондырғылар",quit:"Шығу",statistics:"Санақ",monitoring:"Бақылау",line:"Қызмет тізімі",all:"Барлығы",reserve:"Бронь",serviced:"Қызмет корсетілген",not_came:"Келмеген клиенттер",postponed:"Қайта бағытталған",operator:"Оператор",window:"Nthtpt",call_time:"Шақырылған уақыты",start_time:"Басталған уақыты",ticket_number:"Билет нөмірі",excellent:"Өте жақсы",good:"Орташа",bad:"Нашар",average:"Орташа бағасы",choose_lang:"Тіл таңдаңыз"};var _ru={help:"Помощь",settings:"Настройки",quit:"Выход",statistics:"Статистика",monitoring:"Мониторинг",line:"Линия",all:"Всего",reserve:"Бронь",serviced:"Обслужено",not_came:"Клиент не пришел",postponed:"Перенаправленные",operator:"Оператор",window:"Окно",call_time:"Время вызова",start_time:"Время начала",ticket_number:"Номер билета",excellent:"Отлично",good:"Удовлетворительно",bad:"Плохо",average:"Средняя оценка",choose_lang:"Выберите язык"};var _en={help:"Help",settings:"Settings",quit:"Quit",statistics:"Statistics",monitoring:"Monitoring",line:"Line",all:"All",reserve:"Reserve",serviced:"Serviced",not_came:"Client hasn't come",postponed:"Postponed",operator:"Operator",window:"Window",call_time:"Call time",start_time:"Start time",ticket_number:"Number of ticket",excellent:"Excellent",good:"Good",bad:"Bad",average:"Average mark",choose_lang:"Choose language"};var _unitStats={};var _laneStats={};var _lanes={};var _msgBuffer=new Array;var nowTemp=new Date;var now=new Date(nowTemp.getFullYear(),nowTemp.getMonth(),nowTemp.getDate(),0,0,0,0);var firstTime=0;jQuery("#logoutLink").click(function(){console.log("logoutLink was clicked");window.location="/";sessionStorage.clear();XmppClient.connection.disconnect()})