function _init(e){jQuery("head").empty();jQuery("head").append("<link href='stylesheets/screen.css' media='screen, projection' rel='stylesheet'>");document.title="Оператор CloudQueue";XmppClient.send("queue","getUsername");_initData=e;location.href="#!unit";jQuery(".buttonContainer .caret").css("margin-left","20px");if(e.lang){_lang=e.lang;var t="";console.log("Lang: "+_lang);if(_lang=="kk"){kk_ru=_kk}else{kk_ru=_ru}jQuery("#help").append(kk_ru.help);jQuery(".settings").append(kk_ru.settings);jQuery("#logoutLink").append(kk_ru.quit);jQuery("#lane").append(kk_ru.lane);jQuery("#totalwaiting").append(kk_ru.totalwaiting);jQuery("#putinqueue").attr("title",kk_ru.returnToQ);jQuery("#postpone").attr("title",kk_ru.postpone);jQuery("#call").attr("title",kk_ru.call);jQuery("#stop").attr("title",kk_ru.end);jQuery("#start").attr("title",kk_ru.start);jQuery("#forward").attr("title",kk_ru.transfer);jQuery("#callpostponed").attr("title",kk_ru.recall);jQuery("#operator-back-to-step-1").attr("title",kk_ru.exitFromQ)}if(e.username){jQuery("#username").text(e.username)}if(e.lanes){_lanes=e.lanes;jQuery(_lanes).each(function(e){var t=_lanes[e];console.log(t)});jQuery(_lanes).each(function(e){var t=_lanes[e];jQuery("#transferBtnGroup ul").append("<li><a href='#' onclick='transfer(\""+t.id+"\")'>"+t.ru+"</a></li>")});var n=false;jQuery(_lanes).each(function(e){var t=_lanes[e];if(!n){jQuery("#lanes").append("<option value='"+t.id+"' selected>"+t.ru+"</option>");n=true}else{jQuery("#lanes").append("<option value='"+t.id+"'>"+t.ru+"</option>")}})}jQuery("#transferBtnGroup ul").append("<li class='divider'></li>");if(e.units){console.log("111111111111111111111111111");jQuery(e.units).each(function(t){var n=e.units[t];jQuery(e.lanes).each(function(e){var t=_lanes[e];console.log(t)})});jQuery("#workers").append("<option value='0'>Любой сотрудник</option>");jQuery(e.units).each(function(t){var n=e.units[t];jQuery("#workers").append("<option value='"+n.unit+"'>"+n.name+"</option>")})}if(e.postponed){_any_postponed=true;jQuery("#recallBtn").addClass("active");jQuery(e.postponed).each(function(t){_count_recall=_count_recall+1;var n=e.postponed[t];jQuery("#forward-select").append("<option value='"+n.id+"'>"+n.ticket+"	"+n.lane_text+":</option>")})}$("#counter").text(_count_recall);if(e.current){console.log("I am in DATA.CURRENT!!!");_token=e.current;console.log(_token);$(".operator-counter").text(_token.ticket);if(_token.started){step="started";callBtnFadeIn();start=true;$start.fadeOut(fadeOutTime,function(){$stop.add($start_counter).fadeIn(fadeOutTime)});setTime()}else if(_token.called){step="called";callBtnFadeIn()}jQuery("#token_lane").append(_token.laneText);jQuery("#info_text").empty();jQuery("#info_text").append(kk_ru.called);_callBtn=false;jQuery(".tokenId").text("Token id (for debug):"+_token.id)}jQuery("#lanes").change(function(){$("#workers").empty();var t=$(this).find(":selected").val();jQuery("#workers").append("<option value='0'>Любой сотрудник</option>");jQuery(e.unit_lanes).each(function(n){var r=e.unit_lanes[n];if(r.lane==t){jQuery("#workers").append("<option value='"+r.unit+"'>"+r.name+"</option>")}})});XmppClient.send("queue",JSON.stringify({action:"statistics"}))}function getSettings(){jQuery("#messageBody").html("<p>"+kk_ru.choose_lang+"</p>"+'<label for="ru_lang"><input type="radio" id="ru_lang" name="lang" value="ru" />Русский</label>'+'<label for="kk_lang"><input type="radio" id="kk_lang" name="lang" value="kk" />Казахский</label>'+'<label for="en_lang"><input type="radio" id="en_lang" name="lang" value="en" />English</label>');$("#message").foundation("reveal","open")}function callBtn(){console.log("call btn clicked");if(_callBtn==false){XmppClient.send("queue","call");_callBtn=true;step="called";_recalled=false}}function showNumbersBtn(){alertify.log("Номера показаны клиенту");console.log("showNumbers btn clicked");XmppClient.send("queue","numbers")}function startBtn(){jQuery("#info_text").empty();jQuery("#info_text").append(kk_ru.started);console.log(_ru.called);stop=false;step="started";start=true;var e=$(".operator-counter").text();$("#"+e).remove();XmppClient.send("queue","start");alertify.success(kk_ru.started);setTime();$start.fadeOut(fadeOutTime,function(){$stop.add($start_counter).fadeIn(fadeOutTime)})}function setTime(){++totalSeconds;secondsLabel.innerHTML=pad(totalSeconds%60);minutesLabel.innerHTML=pad(parseInt(totalSeconds%3600/60));hoursLabel.innerHTML=pad(parseInt(totalSeconds/3600));if(!stop){setTimeout(setTime,1e3)}else{totalSeconds=0}}function pad(e){var t=e+"";if(t.length<2){return"0"+t}else{return t}}function endBtn(){if(calledByTicket!=""){_tokens=removeFunction(_tokens,"id",calledByTicket);calledByTicket=""}if(_any_postponed==true)jQuery("#recallBtn").addClass("active");stop=true;start=false;step="";$("#choosen_number").empty();XmppClient.send("queue","end");operator_steps.back_to_step_1_from_step_2();if($start_counter.is(":visible")){$stop.add($start_counter).fadeOut(fadeOutTime,function(){$start.fadeIn(fadeOutTime)})}else{$stop.fadeOut(fadeOutTime,function(){$start.fadeIn(fadeOutTime)})}clearCounter();alertify.success(kk_ru.ended)}function declineBtn(){clearCounter();jQuery("#token_lane").empty();jQuery("#token_lane").append(_token.laneText);operator_steps.back_to_step_1_from_step_2();$("#choosen_number").empty();XmppClient.send("queue",JSON.stringify({action:"decline",token_id:_token.id}));alertify.success(kk_ru.declined)}function backBtn(){if(start==null||start==false){clearCounter();jQuery("#token_lane").empty();jQuery("#token_lane").append(_token.laneText);operator_steps.back_to_step_1_from_step_2();XmppClient.send("queue",JSON.stringify({action:"back",token_id:_token.id}));alertify.success(kk_ru.back)}else{alertify.error(kk_ru.backError)}}function postponeBtn(){clearCounter();jQuery("#info_text").empty();jQuery("#info_text").append(kk_ru.postponed);stop=true;start=false;operator_steps.back_to_step_1_from_step_2();$("#choosen_number").empty();XmppClient.send("queue","postpone")}function recallClient(){var e=$("#forward-select");var t=e.val();var n=e.find(":selected").text();console.log("Client:"+t);if(t!=null){$("#forward-select option[value='"+t+"']").remove();recall(t);_recallBtn=true;console.log(n);if(firstTime==0){firstTime++;jQuery("body").append(jQuery("<script src='javascripts/jquery.reveal-ck.js'></script"))}$(".operator-counter").text(n.substring(0,3));$("#callpostponed_modal").trigger("reveal:close");callBtnFadeIn()}else{$("#callpostponed_modal").trigger("reveal:close")}$("#choosen_number").empty();return false}function showTokensModal(e){if(step==""){console.log(e);jQuery("#token-select").empty();jQuery(_tokens).each(function(t){var n=_tokens[t];if(n.laneId==e){jQuery("#token-select").append("<option value='"+n.id+"'>"+n.ticket+"</option>")}});if(firstTime==0){firstTime++;jQuery("body").append(jQuery("<script src='javascripts/jquery.reveal.js'></script"))}$("#call_token_modal").reveal()}}function callClientByTicket(){var e=$("#token-select");var t=e.val();var n=e.find(":selected").text();console.log("Client:"+t);if(_callBtn==false&&t!=null){_callBtn=true;_recalled=false;$("#token-select option[value='"+t+"']").remove();console.log(n);$("#call_token_modal").trigger("reveal:close");calledByTicket=t;XmppClient.send("queue",JSON.stringify({action:"callByTicket",ticketTokenId:t}))}return false}function testBtn(){console.log("#forward was clicked");if(firstTime==0){firstTime++;jQuery("body").append(jQuery("<script src='javascripts/jquery.reveal-ck.js'></script"))}$("#forward_modal").reveal();$reveal_forward_links.show();$("#choosen_number").empty();return false}function backToUnit(){$("#body_settings").hide();$("#body").show()}function readBlob(e,t){var n=document.getElementById("files").files;if(!n.length){return}var r=n[0];var i=parseInt(e)||0;var s=parseInt(t)||r.size-1;var o=new FileReader;o.onloadend=function(e){if(e.target.readyState==FileReader.DONE){document.getElementById("byte_content").textContent=e.target.result;XmppClient.send("queue",JSON.stringify({action:"parseNumbers",numbers:jQuery("#byte_content").text()}))}};var u=r.slice(i,s+1);o.readAsBinaryString(u)}function settingsBtn(){var e="<style>"+"#byte_content {"+"  margin: 5px 0;"+"  max-height: 100px;"+"  overflow-y: auto;"+"  overflow-x: hidden;"+"}"+"#byte_range { margin-top: 5px; }"+"</style>"+'<a href="#" onclick="backToUnit()">Back</a>'+'<input type="file" id="files" name="file" /> Read bytes: '+'<span class="readBytesButtons">'+'<button id="fileToString" onclick="readBlob(null, null)">entire file</button>'+"</span>"+'<div id="byte_content"></div>';$("#body").hide();$("#body_settings").show();if($("#body_settings").html().length==0){$("#body_settings").append(e)}}function change_lang(){var e=document.getElementsByName("lang");for(var t=0;t<e.length;t++){if(e[t].checked){_lang=e[t].value}}if(_lang=="kk"){kk_ru=_kk}else{kk_ru=_ru}jQuery(_laneStats).each(function(e){var t=_laneStats[e];var n=null;var r=getLane(t.lane);if(r!=null){if(_lang=="ru"){n=r.ru}else if(_lang=="kk"){n=r.kk}else if(_lang=="en"){n=r.en}jQuery(".operator-services-list").append("<p onclick = 'showTokensModal();' class='operator-services-list-name'>"+n+"<span class='operator-services-list-item'>"+t.waiting+"</span></p>")}});console.log("LANGUAGE IS: "+_lang);$("#message").foundation("reveal","close");XmppClient.send("queue",JSON.stringify({action:"changeLang",user:sessionStorage.jid,language:_lang}))}function recall(e){XmppClient.send("queue",JSON.stringify({action:"recall",token:e}));return false}function getLane(e){var t=null;jQuery(_lanes).each(function(n){if(_lanes[n].id==e){t=_lanes[n]}});return t}function transferTest(){var e=jQuery("#lanes").val();var t=jQuery("#workers").val();rButton=jQuery("#position").val();console.log("Lane1: "+e);console.log("Lane2: "+t);console.log("Token: "+_token);if(_token.ticket!=null){_transferred=true;console.log("I am in _token");jQuery("#info_text").empty();jQuery("#info_text").append(kk_ru.transferred);stop=true;console.log("============Transferred: "+kk_ru.transferred);if(t==0){console.log(e);transfer(null,e,false)}else{console.log(t);transfer(e,t,false)}}$("#forward_modal").trigger("reveal:close");clearCounter();jQuery("#info_text").empty();jQuery("#info_text").append(_ru.transfered);alertify.success(kk_ru.transferred);operator_steps.back_to_step_1_from_step_2();return false}function transferReturnTest(){var e=jQuery("#lanes").val();var t=jQuery("#workers").val();rButton=jQuery("#position").val();console.log(e);console.log(t);if(_token.ticket!=null){_transferred=true;console.log("I am in _token");if(_any_postponed==true)jQuery("#recallBtn").addClass("active");jQuery("#info_text").empty();jQuery("#info_text").append(kk_ru.transferred);stop=true;if(t==0){console.log(e);transfer(null,e,true)}else{console.log(t);transfer(e,t,true)}}clearCounter();$("#forward_modal").trigger("reveal:close");alertify.success(kk_ru.transferredAndBack);operator_steps.back_to_step_1_from_step_2();return false}function transfer(e,t,n){console.log(t);console.log(_token.id);console.log(rButton+" radioButton");XmppClient.send("queue",JSON.stringify({action:"transfer",token:_token.id,laneName:e,destination:t,radioButton:rButton,returnToken:n}));return false}function _onMessage(e){var t={};try{t=JSON.parse(e)}catch(n){console.warn("unit got non-JSON message:"+e);return}console.log(t);if(_laneStats){processMessage(t)}else{if(t.stats){_laneStats=t.stats;jQuery(_laneStats).each(function(e){var t=_laneStats[e];var n=null;var r=getLane(t.lane);if(r!=null){if(_lang=="ru"){n=r.ru}else if(_lang=="kk"){n=r.kk}else if(_lang=="en"){n=r.en}jQuery(".operator-services-list").append("<p onclick=\"showTokensModal('"+t.lane+"');\" class='operator-services-list-name'>"+n+"<span class='operator-services-list-item' id='"+t.lane+"'>"+(t.waiting+t.postponed+t.transferred)+"</span></p>")}});jQuery(_msgBuffer).each(function(e){processMessage(_msgBuffer[e])})}if(t.tokens){_tokens=t.tokens}else{_msgBuffer.push(t)}}}function removeFunction(e,t,n){return e.filter(function(e){return e[t]!=n})}function processMessage(e){console.log("MSG.PUBSUB is "+e.pubsub);console.log(e);if(e.pubsub){console.log("I am in MSG.PUBSUB");console.log(e.postpone);if(!e.postpone){console.log("not postpone")}if(_recalled==false){if(e.newticket){var t=$("#"+e.newticket.lane);t.text(parseInt(t.text())+1)}else if(e.called){console.log("-------------"+e.lane);if(!e.postpone){var t=$("#"+e.lane);console.log(t.text());console.log(parseInt(t.text()));if(parseInt(t.text())>0){t.text(parseInt(t.text())-1)}}}else if(e.transferred){var t=$("#"+e.lane);t.text(parseInt(t.text())+1)}else if(e.waiting){console.log($("#g").text());console.log($("#b").text());console.log($("#a").text());console.log("waiting");var t=$("#"+e.lane);t.text(parseInt(t.text())+1)}}}else if(e.token){console.log("I am in MSG.TOKEN");_token=e.token;jQuery("#token_lane").empty();jQuery("#token_lane").append(_token.laneText);jQuery(".tokenId").text("Token id (for debug):"+_token.id);if(_callBtn==true){$(".operator-counter").text(_token.ticket);alertify.success("Клиент вызван");callBtnFadeIn();step="called";_callBtn=false}else if(jQuery("#recallBtn").hasClass("active")&&_recallBtn==true){_recallBtn=false;_count_recall=_count_recall-1;jQuery("#counter").text(_count_recall);jQuery("#info_text").empty();jQuery("#info_text").append(kk_ru.called)}else if(_transferred==true){jQuery("#info_text").empty();jQuery("#info_text").append(kk_ru.transferred);_transferred=false}if(_token.status=="postponed"){var t=$("#"+_token.lane);t.text(parseInt(t.text())+1);_any_postponed=true;alertify.success("Клиент отложен");jQuery("#forward-select").append("<option value='"+_token.id+"'>"+_token.ticket+"	"+_token.laneText+":</option>")}else if(_token.status=="recalled"){var t=$("#"+_token.lane);if(parseInt(t.text())>0){t.text(parseInt(t.text())-1)}_any_postponed=true;alertify.success("Клиент вызван")}else{if(jQuery("#recallClients").is(":empty")){_any_postponed=false}console.log("Checking if empty-------------------------")}}else if(e.firstname){console.log("I am in MSG.FIRSTNAME");username=e.firstname;jQuery("#username").text(username);console.log("=================================Username: "+username)}else if(e.number){_msg=e;_choosen_number=e.content.number;alertify.success("Клиент выбрал номер: "+_choosen_number);$("#choosen_number").empty();$("#choosen_number").append("<span>Клиент выбрал номер: "+_choosen_number+"</span>")}else{jQuery("#recallBtn").removeClass("active");console.log("I am in ELSE");_token={};if(_callBtn){alertify.error("Клиент не может быть вызван")}_callBtn=false;if(jQuery("#declineBtn").hasClass("active")){jQuery("#declineBtn").removeClass("active");jQuery("#callBtn").addClass("active");if(_any_postponed==true)jQuery("#recallBtn").addClass("active");jQuery("#startBtn").removeClass("active");jQuery("#info_text").empty();$("#choosen_number").empty();jQuery("#info_text").append(kk_ru.declined)}else{jQuery("#callBtn").addClass("active");jQuery("#token_lane").empty();jQuery("#token_lane").append("---");jQuery("#info_text").empty();jQuery("#info_text").append(kk_ru.no_clients)}}console.log("pubsub finished");console.log($("#g").text());console.log($("#b").text());console.log($("#a").text())}function clearCounter(){$(".operator-counter").empty()}function _onStatus(e){if(e=="DISCONNECTED"){console.error("Disconnected")}}var _ru={lane:"Услуга",totalwaiting:"Всего ожидают",served:"Вы обслужили",call:"Вызвать_клиента",recall:"Вызвать_отложенного",start:"Начать_обслуживание",end:"Завершить_обслуживание",postpone:"Отложить",transfer:"Перенаправить",exitFromQ:"Отклонить клиента",returnToQ:"Вернуть в очередь клиента",status:"Статус",noclient:"Клиентов нет",waiting:"Клиент ожидает",called:"Клиент вызван",started:"Обслуживание начато",ended:"Обслуживание завершено",transferred:"Клиент перенаправлен",transferredAndBack:"Клиент перенаправлен с возвратом",postponed:"Клиент отложен",help:"Помощь",settings:"Настройки",quit:"Выход",no_clients:"Нет клиентов",declined:"Клиент отклонен",back:"Клиент возвращен",backError:"Завершите обслуживание",choose_lang:"Выберите язык"};var _kk={lane:"Қызмет",totalwaiting:"Күтушілер саны",served:"Қызмет көрсетілгендер саны",call:"Клиентті шақыру",recall:"Тоқтатылған клиентті шақыру",start:"Қызметті бастау",end:"Қызметті аяқтау",postpone:"Уақытша тоқтату",transfer:"Бағыттау",returnToQ:"Клиент келмеді",status:"Жай-күйі",noclient:"Клиенттер жоқ",waiting:"Клиент күтуде",called:"Клиент шақырылды",started:"Қызмет көрсетілуде",ended:"Қызмет көрсету аяқталды",transferred:"Клиент бағытталды",postponed:"Клиент уақытша тоқтатылды",help:"Көмек",settings:"Қондырғылар",quit:"Шығу",back:"Клиент возвращен",backError:"Завершите обслуживание",no_clients:"Клиенттер жоқ",declined:"Клиент келмеді",exitFromQ:"Клиент келмеді",choose_lang:"Тіл таңдаңыз"};var firstTime=0;var step="";var _token=null;var _laneStats=null;var _initData=null;var _msgBuffer=new Array;var _lanes={};var _lang=null;var username=null;var kk_ru=null;var _callBtn=false;var _recallBtn=false;var _transferred=false;var _recalled=false;var _any_postponed=false;var _count_recall="";var _tokens=null;var calledByTicket="";var _choosen_number="";var _msg="";var minutesLabel=document.getElementById("minutes");var secondsLabel=document.getElementById("seconds");var hoursLabel=document.getElementById("hours");var totalSeconds=0;var stop=false;var start=null;var body_text="";var rButton=1